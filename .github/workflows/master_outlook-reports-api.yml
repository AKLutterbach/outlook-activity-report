# Deploy Azure Functions to outlook-reports-api
# Uses isolated deployment folder with locked package versions

name: Deploy API to Azure Function App

on:
  push:
    branches:
      - master
    paths:
      - 'api/**'
      - '.github/workflows/master_outlook-reports-api.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  AZURE_FUNCTIONAPP_NAME: 'outlook-reports-api'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: Setup Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'Build API'
        run: |
          cd api
          npm ci
          npm run build
          echo "✓ TypeScript compiled"
          ls -la dist/

      - name: 'Create Deployment Package'
        run: |
          mkdir -p deploy
          # Copy deployment package.json (has locked versions)
          cp api/functions-package.json deploy/package.json
          cp api/npm-shrinkwrap.json deploy/npm-shrinkwrap.json
          # Copy compiled code
          cp -r api/dist deploy/
          # Copy host.json
          cp api/host.json deploy/
          # Copy function.json folders (v3 programming model)
          cp -r api/health deploy/
          # Install production dependencies with locked versions
          cd deploy
          npm ci --omit=dev
          echo "✓ Deployment package ready"
          ls -la
          echo "health folder:"
          ls -la health/

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_DDE9FC96B9E749848B05B8DF0F8E4859 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_94571B71B4C94F1D97335983DFC3F9C4 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_3B8EAF1FA046422D8B38F8C0305B2435 }}

      - name: 'Deploy to Azure Functions'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          slot-name: 'Production'
          package: deploy
          