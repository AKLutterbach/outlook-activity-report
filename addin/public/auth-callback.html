<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Auth Callback</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
  <div style="text-align:center; padding:40px;">
    <p>Processing sign-in...</p>
  </div>
  <script>
    Office.onReady(() => {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      const error = params.get('error');

      if (error) {
        Office.context.ui.messageParent(JSON.stringify({ 
          success: false, 
          error: error,
          error_description: params.get('error_description')
        }));
        return;
      }

      if (!code || !state) {
        Office.context.ui.messageParent(JSON.stringify({ 
          success: false, 
          error: 'missing_code'
        }));
        return;
      }

      // Exchange code for token via API
      fetch('/api/auth/exchange', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ code, state })
      })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        Office.context.ui.messageParent(JSON.stringify({ 
          success: true,
          userId: data.userId,
          email: data.email,
          tenantId: data.tenantId
        }));
      })
      .catch(err => {
        Office.context.ui.messageParent(JSON.stringify({ 
          success: false, 
          error: err.message 
        }));
      });
    });
  </script>
</body>
</html>
